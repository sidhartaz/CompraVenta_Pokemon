<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Card Trader - Plataforma de Coleccionistas</title>
    <!-- Fuentes e Iconos -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- Tu CSS -->
    <link rel="stylesheet" href="styles.css">
</head>
<body>

    <!-- ======================================================= -->
    <!-- 1. SECCIÓN DE LOGIN / REGISTRO                         -->
    <!-- ======================================================= -->
    <div class="auth-container" id="auth-section">
        <div class="auth-background">
            <div class="circle c1"></div>
            <div class="circle c2"></div>
        </div>
    
        <!-- LOGIN -->
        <div class="auth-card" id="form-login">
            <div class="auth-header">
                <div class="logo-auth"><i class="fa-solid fa-layer-group"></i></div>
                <h2>Bienvenido</h2>
                <p>Ingresa a tu cuenta</p>
            </div>
            <form onsubmit="handleLogin(event)">
                <div class="form-group">
                    <label>Correo Electrónico</label>
                    <div class="input-icon-wrapper">
                        <i class="fa-regular fa-envelope"></i>
                        <input type="email" id="login-email" class="form-input pl-4" required>
                    </div>
                </div>
                <div class="form-group">
                    <label>Contraseña</label>
                    <div class="input-icon-wrapper">
                        <i class="fa-solid fa-lock"></i>
                        <input type="password" id="login-pass" class="form-input pl-4" required>
                    </div>
                </div>
                <button type="submit" class="btn-block">Iniciar Sesión</button>
            </form>
            <div class="auth-footer">
                <p>¿No tienes cuenta? <a onclick="toggleAuth('register')">Regístrate gratis</a></p>
            </div>
        </div>
    
        <!-- REGISTRO -->
        <div class="auth-card hidden" id="form-register">
            <div class="auth-header">
                <h2>Crear Cuenta</h2>
                <p>Únete a la comunidad</p>
            </div>
            <form onsubmit="handleRegister(event)">
                <div class="form-group">
                    <label>Nombre Completo</label>
                    <div class="input-icon-wrapper">
                        <i class="fa-regular fa-user"></i>
                        <input type="text" id="reg-name" class="form-input pl-4" placeholder="Tu nombre" required>
                    </div>
                </div>
                <div class="form-group">
                    <label>Correo Electrónico</label>
                    <div class="input-icon-wrapper">
                        <i class="fa-regular fa-envelope"></i>
                        <input type="email" id="reg-email" class="form-input pl-4" placeholder="email@ejemplo.com" required>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Quiero ser:</label>
                    <div class="role-selector">
                        <label class="radio-card">
                            <input type="radio" name="role" value="cliente" checked>
                            <div class="card-content">
                                <i class="fa-solid fa-bag-shopping"></i><span>Cliente</span>
                            </div>
                        </label>
                        <label class="radio-card">
                            <input type="radio" name="role" value="vendedor">
                            <div class="card-content">
                                <i class="fa-solid fa-store"></i><span>Vendedor</span>
                            </div>
                        </label>
                    </div>
                </div>

                <div class="form-group">
                    <label>Contraseña</label>
                    <div class="input-icon-wrapper">
                        <i class="fa-solid fa-lock"></i>
                        <input type="password" id="reg-pass" class="form-input pl-4" required>
                    </div>
                </div>
                
                <button type="submit" class="btn-block">Crear Cuenta</button>
            </form>
            <div class="auth-footer">
                <p>¿Ya tienes cuenta? <a onclick="toggleAuth('login')">Inicia Sesión</a></p>
            </div>
        </div>
    </div>

    <!-- ======================================================= -->
    <!-- 2. APP PRINCIPAL                                        -->
    <!-- ======================================================= -->
    <div class="dashboard-container hidden" id="main-app">
        
        <!-- SIDEBAR -->
        <aside class="sidebar">
            <div class="logo-container">
                <div class="logo-placeholder"><i class="fa-solid fa-layer-group"></i> Card Trader</div>
            </div>

            <nav class="menu">
                <a href="#" class="menu-item active" onclick="showView('home', this)">
                    <i class="fa-solid fa-house"></i> Inicio
                </a>
                <a href="#" class="menu-item" onclick="showView('catalog', this)">
                    <i class="fa-solid fa-magnifying-glass"></i> Buscar Cartas
                </a>
                <a href="#" class="menu-item" onclick="showView('publications', this)">
                    <i class="fa-solid fa-list"></i> Publicaciones
                </a>
                
                <div class="menu-separator">GESTIÓN</div>
                
                <a href="#" class="menu-item" onclick="showView('dashboard', this)">
                    <i class="fa-solid fa-box-open"></i> Mis Cartas
                </a>
                <a href="#" class="menu-item" onclick="toggleModal()">
                    <i class="fa-solid fa-plus-circle"></i> Publicar Carta
                </a>
                <a href="#" class="menu-item"><i class="fa-solid fa-handshake"></i> Intercambios</a>
                <a href="#" class="menu-item" onclick="showView('history', this); loadOrderHistory();"><i class="fa-solid fa-clock-rotate-left"></i> Historial</a>
                
                <div class="menu-separator">CUENTA</div>

                <div class="menu-separator admin-only">ADMINISTRACIÓN</div>
                <a href="#" class="menu-item admin-only" onclick="showView('admin', this)">
                    <i class="fa-solid fa-shield-halved"></i> Panel Admin
                </a>

                <a href="#" class="menu-item" onclick="showView('dashboard', this)">
                    <i class="fa-solid fa-user"></i> Mi Perfil
                </a>
                <a href="#" class="menu-item" onclick="logout()">
                    <i class="fa-solid fa-right-from-bracket"></i> Cerrar Sesión
                </a>
            </nav>

            <div class="user-footer">
                <div class="user-avatar-small"><i class="fa-solid fa-user"></i></div>
                <div class="user-info-mini">
                    <span id="user-display-name">Usuario</span>
                    <a href="#" onclick="logout()">Cerrar sesión</a>
                </div>
            </div>
        </aside>

        <!-- CONTENIDO PRINCIPAL -->
        <main class="main-content">
            
            <header class="top-header">
                <h1 id="page-title">Bienvenido</h1>
                <div class="header-actions">
                    <button class="btn-secondary"><i class="fa-regular fa-bell"></i></button>
                    <button class="btn-primary" onclick="toggleModal()">
                        <i class="fa-solid fa-plus"></i> Nueva Publicación
                    </button>
                </div>
            </header>

            <!-- VISTA HOME -->
            <div id="view-home" class="view-section">
                <div class="hero-banner">
                    <div class="hero-content">
                        <h2>El Mercado de Coleccionistas</h2>
                        <p>Compra, vende e intercambia cartas de Pokémon, Yu-Gi-Oh! y Mitos y Leyendas con seguridad garantizada.</p>
                        <button class="btn-white" onclick="showView('catalog', document.querySelector('.menu-item:nth-child(2)'))">
                            Explorar Cartas
                        </button>
                    </div>
                    <div class="hero-decoration"><i class="fa-solid fa-layer-group"></i></div>
                </div>

                <div class="categories-row">
                    <div class="category-pill active"><i class="fa-solid fa-fire"></i> Tendencias</div>
                    <div class="category-pill"><i class="fa-solid fa-bolt"></i> Pokémon</div>
                    <div class="category-pill"><i class="fa-solid fa-dragon"></i> Yu-Gi-Oh!</div>
                    <div class="category-pill"><i class="fa-solid fa-scroll"></i> Mitos y Leyendas</div>
                </div>

                <div class="section-header">
                    <h3>Últimas Publicaciones</h3>
                    <a href="#" onclick="showView('catalog')">Ver todo</a>
                </div>

                <div class="cards-grid" id="home-listings"></div>
            </div>

            <!-- VISTA DASHBOARD -->
            <div id="view-dashboard" class="view-section hidden">
                <div class="grid-layout">
                    <div class="col-left">
                        <div class="card profile-card">
                            <div class="card-header"><h3>Información de Perfil</h3></div>
                            <div class="card-body">
                                <div class="profile-detail">
                                    <label>Nombre</label><p id="profile-name">Cargando...</p>
                                </div>
                                <div class="profile-detail">
                                    <label>Correo</label><p id="profile-email">Cargando...</p>
                                </div>
                                <div class="profile-detail">
                                    <label>Membresía</label>
                                    <span class="badge badge-success" id="profile-role">Vendedor</span>
                                </div>
                                <div class="profile-detail">
                                    <label>Reputación</label>
                                    <div class="stars">
                                        <i class="fa-solid fa-star"></i>
                                        <i class="fa-solid fa-star"></i>
                                        <i class="fa-solid fa-star"></i>
                                        <i class="fa-solid fa-star"></i>
                                        <i class="fa-solid fa-star-half-stroke"></i>
                                    </div>
                                </div>
                                <button class="btn-block">Editar Cliente</button>
                            </div>
                        </div>
                    </div>

                    <div class="col-right">
                        <div class="card inventory-section">
                            <div class="card-header"><h3>Inventario Destacado</h3></div>
                            <div class="card-body flex-row">
                                <div class="card-image-container">
                                    <img src="charizard.png" alt="Carta">
                                </div>
                                <div class="card-info">
                                    <h4>Charizard Holográfico</h4>
                                    <p class="subtext">Edición Base Set 1st Edition</p>
                                    <div class="tags">
                                        <span class="tag verification">Validado Nivel 3</span>
                                    </div>
                                    <div class="price-box">
                                        <span class="currency">$150.000 CLP</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="card publications-list">
                            <div class="card-header"><h3>Publicaciones Activas</h3></div>
                            <div class="card-body" id="seller-listings"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- VISTA PANEL ADMIN -->
            <div id="view-admin" class="view-section hidden">
                <div class="grid-layout">
                    <div class="col-left">
                        <div class="card">
                            <div class="card-header">
                                <h3>Gestión de Usuarios</h3>
                                <button class="btn-secondary" onclick="loadAdminUsers()">Recargar usuarios</button>
                            </div>
                            <div class="card-body">
                                <table class="table" id="admin-users-table">
                                    <tr>
                                        <th>Nombre</th>
                                        <th>Email</th>
                                        <th>Rol</th>
                                        <th>Activo</th>
                                        <th>Acciones</th>
                                    </tr>
                                    <!-- Filas cargadas por JS -->
                                </table>
                            </div>
                        </div>
                    </div>

                    <div class="col-right">
                        <div class="card">
                            <div class="card-header">
                                <h3>Publicaciones Pendientes</h3>
                                <button class="btn-secondary" onclick="loadPendingPublications()">Recargar publicaciones</button>
                            </div>
                            <div class="card-body">
                                <table class="table" id="admin-publications-table">
                                    <tr>
                                        <th>Carta</th>
                                        <th>Vendedor</th>
                                        <th>Precio</th>
                                        <th>Acciones</th>
                                    </tr>
                                    <!-- Filas cargadas por JS -->
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- VISTA HISTORIAL -->
            <div id="view-history" class="view-section hidden">
                <div class="card">
                    <div class="card-header history-header">
                        <div>
                            <h3>Historial de órdenes</h3>
                            <p class="subtext">Consulta todas tus compras, reservas y ventas con su trazabilidad.</p>
                        </div>
                        <div class="history-filters">
                            <select class="form-input" id="history-status-filter" onchange="loadOrderHistory()">
                                <option value="">Todos los estados</option>
                                <option value="pendiente">Pendiente</option>
                                <option value="reservada">Reservada</option>
                                <option value="pagada">Pagada</option>
                                <option value="cancelada">Cancelada</option>
                            </select>
                        </div>
                    </div>
                    <div class="history-tabs">
                        <button class="history-tab active" data-type="" onclick="setHistoryTypeFilter('')">Todo</button>
                        <button class="history-tab" data-type="compra" onclick="setHistoryTypeFilter('compra')">Compras</button>
                        <button class="history-tab" data-type="reserva" onclick="setHistoryTypeFilter('reserva')">Reservas</button>
                    </div>
                    <div class="history-summary" id="history-summary">
                        <div class="history-summary-card">
                            <p class="summary-label">Compras</p>
                            <p class="summary-value">0</p>
                            <p class="summary-sub">Totales</p>
                        </div>
                        <div class="history-summary-card">
                            <p class="summary-label">Reservas</p>
                            <p class="summary-value">0</p>
                            <p class="summary-sub">Totales</p>
                        </div>
                        <div class="history-summary-card">
                            <p class="summary-label">Reservas activas</p>
                            <p class="summary-value">0</p>
                            <p class="summary-sub">En estado reservada</p>
                        </div>
                    </div>
                    <div class="card-body" id="history-list">
                        <p class="subtext">Carga el historial para ver tus movimientos.</p>
                    </div>
                </div>
            </div>

            <!-- VISTA PUBLICACIONES -->
            <div id="view-publications" class="view-section hidden">
                <div class="card">
                    <div class="card-header publications-header">
                        <div>
                            <h3>Publicaciones disponibles</h3>
                            <p class="subtext">Explora publicaciones aprobadas, revisa su disponibilidad y contacta al vendedor.</p>
                        </div>
                        <div class="pill-counter">
                            <span id="publications-count">0</span> activas
                        </div>
                    </div>
                    <div class="card-body">
                        <div id="publications-list" class="publications-grid">
                            <p class="subtext">Cargando publicaciones...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- VISTA DETALLE CARTA -->
            <div id="view-card-detail" class="view-section hidden">
                <button class="btn-secondary" onclick="goBackToCatalog()">
                    ← Volver al Catálogo
                </button>
                <div id="cardDetailContent">
                    <!-- Contenido dinámico -->
                </div>
            </div>

            <!-- VISTA CATALOGO -->
            <div id="view-catalog" class="view-section hidden">
                <h2>Buscar Cartas Pokémon</h2>

                <div class="search-bar-container">
                    <input 
                        type="text"
                        id="searchInput"
                        class="search-input"
                        placeholder="Buscar cartas (ej: charizard, pikachu, squirtle)...">
                    <button class="btn-primary" onclick="searchCards()">Buscar</button>
                </div>

                <div id="resultsContainer" class="cards-grid">
                    <!-- Cartas buscadas -->
                </div>
            </div>

        </main>
    </div>

    <!-- MODAL DE PUBLICACIÓN -->
    <div class="modal-overlay" id="modalPublish">
        <div class="modal-container">
            <div class="modal-header">
                <h2>Nueva Publicación</h2>
                <button class="btn-close" onclick="toggleModal()">
                    <i class="fa-solid fa-xmark"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="publish-form" onsubmit="handleCreateListing(event)">
                    <div class="form-group">
                        <label>Nombre de la publicación</label>
                        <input type="text" class="form-input" id="listing-name" placeholder="Charizard holográfico primera edición" required>
                    </div>
                    <div class="form-group">
                        <label>ID de la carta (TCGplayer ID guardado en base de datos)</label>
                        <input type="text" class="form-input" id="listing-card-id" placeholder="base1-4">
                        <small>Usa el buscador para copiar el ID exacto de la carta (opcional).</small>
                    </div>
                    <div class="form-row-2">
                        <div class="form-group">
                            <label>Condición</label>
                            <select class="form-input" id="listing-condition" required>
                                <option value="Mint">Mint</option>
                                <option value="Near Mint">Near Mint</option>
                                <option value="Lightly Played">Lightly Played</option>
                                <option value="Damaged">Damaged</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Precio (CLP)</label>
                            <input type="number" class="form-input" id="listing-price" placeholder="150000" min="0" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Descripción</label>
                        <textarea class="form-input" id="listing-description" rows="3" placeholder="Notas opcionales sobre la carta"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Imagen de la carta (opcional)</label>
                        <input type="file" class="form-input" accept="image/*" id="listing-image" onchange="handleListingImageChange(event)">
                        <small>La imagen se guardará en la base de datos junto con la publicación.</small>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn-secondary" onclick="toggleModal()">Cancelar</button>
                        <button type="submit" class="btn-primary">Enviar a Revisión</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- ======================================================= -->
    <!-- LÓGICA JAVASCRIPT                                       -->
    <!-- ======================================================= -->
        <script>
        let authToken = null;
        let currentUser = null;
        let listingImageBase64 = null;
        let historyOrdersCache = [];
        let historyTypeFilter = '';

        function apiFetch(url, options = {}) {
            const headers = options.headers || {};
            if (authToken) {
                headers['Authorization'] = 'Bearer ' + authToken;
            }
            return fetch(url, { ...options, headers });
        }

        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return date.toLocaleString('es-CL', { dateStyle: 'short', timeStyle: 'short' });
        }

        function renderListingCard(listing) {
            const card = listing.card || {};
            const image = listing.imageData || card.images?.large || 'black.jpg';
            const cardName = listing.name || card.name || listing.cardId;
            const listingId = listing.id || listing._id || '';
            const badge = listing.status && listing.status !== 'aprobada'
                ? `<span class="badge-overlay warning">${listing.status.toUpperCase()}</span>`
                : '';

            return `
                <div class="market-card" onclick="showListingDetail('${listingId}','${listing.cardId}')">
                    <div class="market-img-box">
                        <img src="${image}" alt="${cardName}" onerror="this.src='black.jpg'">
                        ${badge}
                    </div>
                    <div class="market-info">
                        <span class="card-game-badge">${card.set?.name || 'Carta'}</span>
                        <h4 class="market-title">${cardName}</h4>
                        <div class="market-meta">
                            <span class="condition-badge">${listing.condition}</span>
                            <span class="market-price">$${listing.price}</span>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderPublicationCard(listing) {
            const card = listing.card || {};
            const seller = listing.sellerId || listing.seller || {};
            const cardName = listing.name || card.name || listing.cardId;
            const image = listing.imageData || card.images?.small || 'black.jpg';
            const available = listing.status === 'aprobada' && listing.isActive !== false;
            const availabilityLabel = available ? 'Disponible' : 'No disponible';
            const listingId = listing.id || listing._id;

            return `
                <div class="publication-card" onclick="showListingDetail('${listingId}','${listing.cardId || ''}')">
                    <div class="publication-main">
                        <div class="publication-thumb">
                            <img src="${image}" alt="${cardName}" onerror="this.src='black.jpg'">
                        </div>
                        <div class="publication-info">
                            <div class="publication-title-row">
                                <h4 class="publication-title">${cardName}</h4>
                                <span class="availability-pill ${available ? 'available' : 'unavailable'}">${availabilityLabel}</span>
                            </div>
                            <p class="publication-desc">${listing.description || 'Sin descripción'}</p>
                            <div class="publication-meta">
                                <span class="seller-chip"><i class="fa-solid fa-user"></i> ${seller.name || 'Vendedor'}</span>
                                <span class="seller-chip"><i class="fa-solid fa-envelope"></i> ${seller.email || 'Correo no disponible'}</span>
                                <span class="seller-chip"><i class="fa-solid fa-tag"></i> ${listing.condition}</span>
                            </div>
                        </div>
                        <div class="publication-price">
                            <span>Precio</span>
                            <strong>$${listing.price}</strong>
                            <small>${card.set?.name || 'Set no disponible'}</small>
                        </div>
                    </div>
                    ${available
                        ? `<div class="publication-actions">
                            <button class="btn-secondary" onclick="event.stopPropagation(); createOrder('${listingId}','reserva')">Reservar</button>
                            <a class="btn-link" onclick="event.stopPropagation();" href="mailto:${seller.email || ''}?subject=Interés%20en%20${encodeURIComponent(cardName)}" target="_blank" rel="noopener noreferrer">Contactar vendedor</a>
                            <button class="btn-secondary ghost" onclick="event.stopPropagation(); showListingDetail('${listingId}','${listing.cardId || ''}')">Ver detalle</button>
                        </div>`
                        : `<div class="publication-actions disabled">
                            <span class="availability-note">No disponible para compra, reserva ni contacto.</span>
                            <button class="btn-secondary ghost" onclick="event.stopPropagation(); showListingDetail('${listingId}','${listing.cardId || ''}')">Ver detalle</button>
                        </div>`
                    }
                </div>
            `;
        }

        // Cambiar entre login / registro
        function toggleAuth(view) {
            document.getElementById('form-login').classList.toggle('hidden');
            document.getElementById('form-register').classList.toggle('hidden');
        }

        function toggleModal() {
            document.getElementById('modalPublish').classList.toggle('active');
        }

        // Mostrar vista principal (usada por el menú)
        function showView(viewName, element) {
            const sections = ['view-home', 'view-dashboard', 'view-catalog', 'view-publications', 'view-admin', 'view-history', 'view-card-detail'];
            sections.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.classList.add('hidden');
            });

            const target = document.getElementById('view-' + viewName);
            if (target) {
                target.classList.remove('hidden');
            } else {
                console.warn('Vista no encontrada:', 'view-' + viewName);
            }

            document.querySelectorAll('.menu-item').forEach(item => item.classList.remove('active'));
            if (element) element.classList.add('active');

            const titles = {
                home: 'Bienvenido',
                dashboard: 'Mi Panel',
                catalog: 'Buscar Cartas',
                publications: 'Publicaciones',
                admin: 'Panel de Administración',
                'card-detail': 'Detalle de Carta',
                history: 'Historial',
            };
            document.getElementById('page-title').textContent = titles[viewName] || 'Card Trader';

            if (viewName === 'catalog') {
                const query = document.getElementById('searchInput')?.value || '';
                if (!query) loadCatalogListings();
            }

            if (viewName === 'history') {
                loadOrderHistory();
            }

            if (viewName === 'publications') {
                loadPublicationsBoard();
            }
        }

        // Helper para cambiar de vista desde otras funciones (detalle de carta)
        function showSection(sectionId) {
            const sections = ['view-home', 'view-dashboard', 'view-catalog', 'view-publications', 'view-admin', 'view-history', 'view-card-detail'];
            sections.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.classList.add('hidden');
            });
            const target = document.getElementById(sectionId);
            if (target) target.classList.remove('hidden');
        }

        // Al entrar después de login
        function enterApp(user) {
            currentUser = user;

            document.getElementById('auth-section').style.display = 'none';
            document.getElementById('main-app').classList.remove('hidden');
            
            document.getElementById('user-display-name').innerText = user.name;
            document.getElementById('profile-name').innerText = user.name;
            document.getElementById('profile-role').innerText = user.role.toUpperCase();
            document.getElementById('profile-email').innerText = user.email;

            // Mostrar/ocultar cosas solo admin
            const adminItems = document.querySelectorAll('.admin-only');
            adminItems.forEach(el => {
                el.style.display = (user.role === 'admin') ? 'block' : 'none';
            });

            loadHomeListings();
            loadCatalogListings();
            loadPublicationsBoard();
            loadSellerListings();
            loadOrderHistory();
        }

        async function loadHomeListings() {
            const container = document.getElementById('home-listings');
            if (!container) return;
            container.innerHTML = '<p>Cargando publicaciones...</p>';

            try {
                const res = await fetch('/api/listings');
                const data = await res.json();

                if (!Array.isArray(data) || data.length === 0) {
                    container.innerHTML = '<p>No hay publicaciones aprobadas.</p>';
                    return;
                }

                const latest = data.slice(0, 4);
                container.innerHTML = latest.map(renderListingCard).join('');
            } catch (err) {
                console.error(err);
                container.innerHTML = '<p>Error cargando publicaciones.</p>';
            }
        }

        async function loadCatalogListings() {
            const container = document.getElementById('resultsContainer');
            if (!container) return;
            container.innerHTML = '<p>Cargando catálogo...</p>';

            try {
                const res = await fetch('/api/listings');
                const data = await res.json();

                if (!Array.isArray(data) || data.length === 0) {
                    container.innerHTML = '<p>No hay publicaciones activas.</p>';
                    return;
                }

                container.innerHTML = data.map(renderListingCard).join('');
            } catch (err) {
                console.error(err);
                container.innerHTML = '<p>Error cargando catálogo.</p>';
            }
        }

        async function loadPublicationsBoard() {
            const container = document.getElementById('publications-list');
            if (!container) return;
            container.innerHTML = '<p class="subtext">Cargando publicaciones...</p>';

            try {
                const res = await fetch('/api/listings');
                const data = await res.json();

                const counter = document.getElementById('publications-count');
                if (counter) counter.textContent = Array.isArray(data) ? data.length : 0;

                if (!Array.isArray(data) || data.length === 0) {
                    container.innerHTML = '<p>No hay publicaciones activas.</p>';
                    return;
                }

                container.innerHTML = data.map(renderPublicationCard).join('');
            } catch (err) {
                console.error(err);
                container.innerHTML = '<p>Error cargando publicaciones.</p>';
            }
        }

        async function loadSellerListings() {
            if (!currentUser || currentUser.role !== 'vendedor') return;
            const container = document.getElementById('seller-listings');
            if (!container) return;

            container.innerHTML = '<p>Cargando tus publicaciones...</p>';

            try {
                const [pendingRes, approvedRes] = await Promise.all([
                    fetch('/api/listings?status=pendiente'),
                    fetch('/api/listings'),
                ]);

                const pending = await pendingRes.json();
                const approved = await approvedRes.json();
                const mine = [...pending, ...approved].filter(lst => lst.sellerId?._id === currentUser.id);

                if (!mine.length) {
                    container.innerHTML = '<p>No tienes publicaciones aún.</p>';
                    return;
                }

                container.innerHTML = mine.map(lst => `
                    <div class="list-item">
                        <div class="item-info">
                            <strong>${lst.card?.name || lst.cardId}</strong>
                            <span>Estado: ${lst.condition}</span>
                        </div>
                        <span class="status-pill ${lst.status === 'aprobada' ? 'delivered' : 'pending'}">${lst.status}</span>
                    </div>
                `).join('');
            } catch (err) {
                console.error(err);
                container.innerHTML = '<p>Error cargando tus publicaciones.</p>';
            }
        }

        function logout() {
            location.reload(); 
        }

        // =============== ADMIN: USUARIOS ==================
        async function loadAdminUsers() {
            if (!authToken) return alert('No autenticado');

            const res = await fetch('/api/admin/users', {
                headers: { 'Authorization': 'Bearer ' + authToken }
            });

            const data = await res.json();
            if (!res.ok) {
                return alert('Error: ' + data.message);
            }

            const table = document.getElementById('admin-users-table');
            table.innerHTML = `
                <tr>
                    <th>Nombre</th>
                    <th>Email</th>
                    <th>Rol</th>
                    <th>Activo</th>
                    <th>Acciones</th>
                </tr>
                ${data.users.map(u => `
                    <tr>
                        <td>${u.name}</td>
                        <td>${u.email}</td>
                        <td>${u.role}</td>
                        <td>${u.isActive ? 'Sí' : 'No'}</td>
                        <td>
                            <button onclick="promoteToSeller('${u._id}')">Hacer vendedor</button>
                            <button onclick="deleteUser('${u._id}')">Eliminar</button>
                        </td>
                    </tr>
                `).join('')}
            `;
        }

        async function promoteToSeller(userId) {
            if (!confirm('¿Convertir a vendedor?')) return;
            const res = await fetch('/api/admin/users/' + userId, {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + authToken
                },
                body: JSON.stringify({ role: 'vendedor' })
            });
            const data = await res.json();
            if (!res.ok) return alert('Error: ' + data.message);
            loadAdminUsers();
        }

        async function deleteUser(userId) {
            if (!confirm('¿Eliminar usuario?')) return;
            const res = await fetch('/api/admin/users/' + userId, {
                method: 'DELETE',
                headers: { 'Authorization': 'Bearer ' + authToken }
            });
            const data = await res.json();
            if (!res.ok) return alert('Error: ' + data.message);
            loadAdminUsers();
        }

        // =============== ADMIN: PUBLICACIONES =============
        async function loadPendingPublications() {
            if (!authToken) return alert('No autenticado');

            const res = await apiFetch('/api/admin/publications?status=pendiente');

            const data = await res.json();
            if (!res.ok) {
                return alert('Error: ' + data.message);
            }

            const table = document.getElementById('admin-publications-table');
            table.innerHTML = `
                <tr>
                    <th>Carta</th>
                    <th>Vendedor</th>
                    <th>Precio</th>
                    <th>Acciones</th>
                </tr>
                ${data.listings.map(p => `
                    <tr>
                        <td>${p.card?.name || p.cardId}</td>
                        <td>${p.sellerId?.name || 'N/A'} (${p.sellerId?.email || ''})</td>
                        <td>${p.price}</td>
                        <td>
                            <button onclick="approvePublication('${p._id}')">Aprobar</button>
                            <button onclick="rejectPublication('${p._id}')">Rechazar</button>
                            <button onclick="deletePublication('${p._id}')">Eliminar</button>
                        </td>
                    </tr>
                `).join('')}
            `;
        }

        async function approvePublication(id) {
            const res = await apiFetch('/api/admin/publications/' + id + '/status', {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ status: 'aprobada' })
            });
            const data = await res.json();
            if (!res.ok) return alert('Error: ' + data.message);
            loadPendingPublications();
        }

        async function rejectPublication(id) {
            const rejectionReason = prompt('Motivo de rechazo:');
            if (rejectionReason === null) return;
            if (!rejectionReason.trim()) return alert('Debes indicar un motivo.');

            const res = await apiFetch('/api/admin/publications/' + id + '/status', {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ status: 'rechazada', rejectionReason })
            });
            const data = await res.json();
            if (!res.ok) return alert('Error: ' + data.message);
            loadPendingPublications();
        }

        async function deletePublication(id) {
            if (!confirm('¿Eliminar publicación?')) return;
            const res = await apiFetch('/api/admin/publications/' + id, { method: 'DELETE' });
            const data = await res.json();
            if (!res.ok) return alert('Error: ' + data.message);
            loadPendingPublications();
        }

        // =============== REGISTRO =========================
        async function handleRegister(e) {
            e.preventDefault();
            console.log("Iniciando registro...");

            const name = document.getElementById('reg-name').value;
            const email = document.getElementById('reg-email').value;
            const password = document.getElementById('reg-pass').value;
            const roleElement = document.querySelector('input[name="role"]:checked');
            const role = roleElement ? roleElement.value : 'cliente';

            try {
                const res = await fetch('/api/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, email, password, role })
                });
                
                const data = await res.json();
                
                if(res.ok) {
                    alert('✅ Registro exitoso. Ahora inicia sesión.');
                    toggleAuth('login');
                } else {
                    alert('❌ Error: ' + data.message);
                }
            } catch (error) {
                console.error(error);
                alert('Error de conexión con el servidor.');
            }
        }

        async function handleListingImageChange(event) {
            const file = event.target.files?.[0];
            if (!file) {
                listingImageBase64 = null;
                return;
            }

            try {
                listingImageBase64 = await new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result);
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                });
            } catch (error) {
                console.error('Error leyendo imagen', error);
                alert('No se pudo leer la imagen seleccionada.');
                listingImageBase64 = null;
            }
        }

        // =============== LOGIN ============================
        async function handleLogin(e) {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-pass').value;

            try {
                const res = await fetch('/api/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });

                const data = await res.json();

                if(res.ok) {
                    authToken = data.token;
                    currentUser = data.user;
                    enterApp(data.user);
                } else {
                    alert('❌ Error: ' + data.message);
                }
            } catch (error) {
                console.error(error);
                alert('Error de conexión con el servidor.');
            }
        }

        async function handleCreateListing(e) {
            e.preventDefault();
            if (!authToken) return alert('Debes iniciar sesión como vendedor.');

            const name = document.getElementById('listing-name').value.trim();
            const cardId = document.getElementById('listing-card-id').value.trim();
            const price = Number(document.getElementById('listing-price').value);
            const condition = document.getElementById('listing-condition').value;
            const description = document.getElementById('listing-description').value;

            if (!name) {
                alert('Debes ingresar el nombre de la publicación.');
                return;
            }

            try {
                const payload = { name, price, condition, description, imageData: listingImageBase64 };
                if (cardId) {
                    payload.cardId = cardId;
                }

                const res = await apiFetch('/api/listings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const data = await res.json();

                if (res.ok) {
                    alert('✅ Publicación enviada a revisión.');
                    document.getElementById('publish-form').reset();
                    listingImageBase64 = null;
                    toggleModal();
                    loadSellerListings();
                    loadHomeListings();
                    loadCatalogListings();
                    loadPublicationsBoard();
                } else {
                    alert('❌ Error: ' + (data.message || 'No se pudo crear la publicación'));
                }
            } catch (error) {
                console.error(error);
                alert('Error de conexión con el servidor.');
            }
        }

        function renderStatusBadge(status) {
            const className = {
                pagada: 'success',
                cancelada: 'danger',
                reservada: 'warning',
                pendiente: 'info',
            }[status] || 'info';
            return `<span class="status-pill status-${className}">${status}</span>`;
        }

        function renderHistoryItem(order) {
            const cardName = order.card?.name || order.listingId?.description || order.listingId?.cardId || 'Carta';
            const image = order.listingId?.imageData || order.card?.images?.small || 'black.jpg';
            const counterpart = currentUser && order.buyerId && order.sellerId
                ? (currentUser.id === (order.buyerId._id || order.buyerId) ? order.sellerId : order.buyerId)
                : null;
            const counterpartName = counterpart?.name || 'Otro usuario';
            const counterpartEmail = counterpart?.email || '';

            const historySteps = (order.history || []).map(step => `
                <div class="history-step">
                    <div class="history-step-header">
                        ${renderStatusBadge(step.status)}
                        <span class="history-step-date">${formatDate(step.changedAt)}</span>
                    </div>
                    <div class="history-step-body">
                        <p class="history-note">${step.note || ''}</p>
                        <p class="history-user">${step.changedBy?.name || 'Sistema'}</p>
                    </div>
                </div>
            `).join('');

            return `
                <div class="history-card">
                    <div class="history-card-header">
                        <div class="history-image-wrapper">
                            <img src="${image}" alt="${cardName}" onerror="this.src='black.jpg'">
                        </div>
                        <div class="history-card-info">
                            <div class="history-card-title">${cardName}</div>
                            <div class="history-card-meta">
                                <span>${order.type === 'reserva' ? 'Reserva' : 'Compra'}</span>
                                ${renderStatusBadge(order.status)}
                                <span class="history-total">${order.total ? '$' + order.total : ''}</span>
                            </div>
                            <p class="history-counterpart">Con: ${counterpartName}${counterpartEmail ? ' · ' + counterpartEmail : ''}</p>
                            <p class="history-dates">Creada: ${formatDate(order.createdAt)}</p>
                        </div>
                    </div>
                    <div class="history-steps">
                        ${historySteps || '<p class="subtext">Sin eventos registrados.</p>'}
                    </div>
                </div>
            `;
        }

        function renderHistoryList(orders) {
            const container = document.getElementById('history-list');
            if (!container) return;

            if (!orders || orders.length === 0) {
                container.innerHTML = '<p>No hay órdenes registradas aún.</p>';
                return;
            }

            container.innerHTML = orders.map(renderHistoryItem).join('');
        }

        function updateHistorySummary(orders = []) {
            const summary = document.getElementById('history-summary');
            if (!summary) return;

            const totalCompras = orders.filter(o => o.type === 'compra').length;
            const totalReservas = orders.filter(o => o.type === 'reserva').length;
            const activeReservas = orders.filter(o => o.type === 'reserva' && o.status === 'reservada').length;

            summary.innerHTML = `
                <div class="history-summary-card">
                    <p class="summary-label">Compras</p>
                    <p class="summary-value">${totalCompras}</p>
                    <p class="summary-sub">Totales</p>
                </div>
                <div class="history-summary-card">
                    <p class="summary-label">Reservas</p>
                    <p class="summary-value">${totalReservas}</p>
                    <p class="summary-sub">Totales</p>
                </div>
                <div class="history-summary-card">
                    <p class="summary-label">Reservas activas</p>
                    <p class="summary-value">${activeReservas}</p>
                    <p class="summary-sub">En estado reservada</p>
                </div>
            `;
        }

        function setHistoryTypeFilter(type) {
            historyTypeFilter = type || '';
            document.querySelectorAll('.history-tab').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.type === historyTypeFilter);
            });

            const filtered = historyTypeFilter
                ? historyOrdersCache.filter(o => o.type === historyTypeFilter)
                : historyOrdersCache;

            renderHistoryList(filtered);
        }

        async function loadOrderHistory() {
            if (!authToken) return;
            const container = document.getElementById('history-list');
            if (!container) return;

            container.innerHTML = '<p>Cargando historial...</p>';
            const status = document.getElementById('history-status-filter')?.value;
            const query = status ? `?status=${status}` : '';

            try {
                const res = await apiFetch('/api/orders' + query);
                const data = await res.json();
                if (!res.ok) {
                    container.innerHTML = `<p>Error: ${data.message || 'No se pudo cargar el historial'}</p>`;
                    return;
                }

                historyOrdersCache = data.orders || [];
                updateHistorySummary(historyOrdersCache);

                const filtered = historyTypeFilter
                    ? historyOrdersCache.filter(order => order.type === historyTypeFilter)
                    : historyOrdersCache;

                renderHistoryList(filtered);
            } catch (error) {
                console.error(error);
                container.innerHTML = '<p>Error al cargar el historial.</p>';
                historyOrdersCache = [];
                updateHistorySummary([]);
            }
        }

        // =============== BUSCAR CARTAS ====================
        async function searchCards() {
            const query = document.getElementById("searchInput").value.trim();
            const container = document.getElementById("resultsContainer");

            if (!query) {
                loadCatalogListings();
                return;
            }

            container.innerHTML = "<p>Buscando...</p>";

            try {
                const res = await fetch(`/api/cards/search?q=${query}`);
                const data = await res.json();

                if (!data.results || data.results.length === 0) {
                    container.innerHTML = "<p>No se encontraron cartas.</p>";
                    return;
                }

                container.innerHTML = "";
                data.results.forEach(item => {
                    const card = item.card || {};
                    const listing = item.listings[0] || null;

                    const listingId = listing?.id || '';
                    const targetCardId = listing?.cardId || card.id || '';
                    const displayName = listing?.name || card.name || listing?.cardId || 'Publicación';
                    const coverImage = listing?.imageData || card.images?.large || 'black.jpg';
                    const priceLabel = listing ? "$" + listing.price : "Sin vendedores";

                    container.innerHTML += `
                        <div class="market-card" onclick="showListingDetail('${listingId}','${targetCardId}')">
                            <div class="market-img-box">
                                <img src="${coverImage}" alt="${displayName}" onerror="this.src='black.jpg'">
                            </div>
                            <div class="market-info">
                                <h4>${displayName}</h4>
                                <span class="market-price">
                                    ${priceLabel}
                                </span>
                            </div>
                        </div>
                    `;
                });
            } catch (err) {
                console.error(err);
                container.innerHTML = "<p>Error buscando cartas.</p>";
            }
        }

        // =============== DETALLE DE CARTA =================
        async function showListingDetail(listingId, cardId) {
            if (!listingId && cardId) {
                return showCardDetail(cardId);
            }

            showSection('view-card-detail');

            const container = document.getElementById("cardDetailContent");
            container.innerHTML = "<p>Cargando publicación...</p>";

            try {
                const [listingRes, cardRes] = await Promise.all([
                    fetch(`/api/listings/${listingId}`),
                    cardId ? fetch(`/api/cards/${cardId}`) : Promise.resolve({ ok: false }),
                ]);

                const listing = await listingRes.json();
                const cardData = cardRes.ok ? await cardRes.json() : {};
                const card = cardData.card || null;

                if (!listingRes.ok) {
                    container.innerHTML = `<p>${listing.message || 'No se pudo cargar la publicación.'}</p>`;
                    return;
                }

                const seller = listing.sellerId || listing.seller || {};
                const available = listing.status === 'aprobada' && listing.isActive !== false;
                const availabilityLabel = available ? 'Disponible' : 'No disponible';
                const coverImage = listing.imageData || card?.images?.large || 'black.jpg';
                const displayName = listing.name || card?.name || listing.cardId;

                container.innerHTML = `
                    <div class="detail-card">
                        <div class="detail-left">
                            <img src="${coverImage}" alt="${card?.name || listing.cardId}" class="detail-img" onerror="this.src='black.jpg'">
                        </div>

                        <div class="detail-right">
                            <div class="detail-title-row">
                                <h2>${displayName}</h2>
                                <span class="availability-pill ${available ? 'available' : 'unavailable'}">${availabilityLabel}</span>
                            </div>

                            <div class="detail-meta">
                                <p><strong>Set:</strong> ${card?.set?.name || 'No disponible'}</p>
                                <p><strong>Rareza:</strong> ${card?.rarity || 'Desconocida'}</p>
                                <p><strong>Condición:</strong> ${listing.condition}</p>
                                <p><strong>Precio:</strong> $${listing.price}</p>
                            </div>

                            <div class="detail-description">
                                <p><strong>Descripción</strong></p>
                                <p>${listing.description || 'Sin descripción proporcionada.'}</p>
                            </div>

                            <div class="seller-list">
                                <div class="seller-card">
                                    <div class="seller-avatar">${(seller.name || 'V')[0]}</div>
                                    <div>
                                        <p class="seller-name">${seller.name || 'Vendedor sin nombre'}</p>
                                        <p class="seller-rating">${seller.email || 'Correo no disponible'}</p>
                                        <p class="seller-rating">Rol: ${seller.role || 'vendedor'}</p>
                                    </div>
                                    <div class="seller-price">
                                        $${listing.price}
                                        <span class="seller-condition">(${listing.condition})</span>
                                    </div>
                                    ${available
                                        ? `<div class="seller-actions">
                                            <button class="btn-secondary" onclick="createOrder('${listing._id || listing.id}','reserva')">Reservar</button>
                                            <a class="btn-primary" href="mailto:${seller.email || ''}?subject=Interés%20en%20${encodeURIComponent(card?.name || listing.cardId)}" target="_blank" rel="noopener noreferrer">Contactar</a>
                                        </div>`
                                        : `<div class="seller-actions disabled">
                                            <span class="availability-note">No disponible para reservar.</span>
                                            <a class="btn-secondary ghost" href="mailto:${seller.email || ''}?subject=Consulta%20sobre%20${encodeURIComponent(card?.name || listing.cardId)}" target="_blank" rel="noopener noreferrer">Contactar</a>
                                        </div>`
                                    }
                                </div>
                            </div>

                            ${card
                                ? `<button class="btn-secondary ghost" onclick="showCardDetail('${card.id}')">Ver más vendedores</button>`
                                : ''}
                        </div>
                    </div>
                `;
            } catch (error) {
                console.error(error);
                container.innerHTML = "<p>Error cargando la publicación.</p>";
            }
        }

        async function showCardDetail(cardId) {
            showSection('view-card-detail');

            const container = document.getElementById("cardDetailContent");
            container.innerHTML = "<p>Cargando carta...</p>";

            try {
                const res = await fetch(`/api/cards/${cardId}`);
                const data = await res.json();

                const card = data.card;
                const listings = data.listings;

                if (!card) {
                    container.innerHTML = "<p>La carta no existe o fue removida.</p>";
                    return;
                }
                const coverImage = (listings[0] && listings[0].imageData) || card.images.large || 'black.jpg';

                container.innerHTML = `
                    <div class="detail-card">

                        <div class="detail-left">
                            <img src="${coverImage}" alt="${card.name}" class="detail-img" onerror="this.src='black.jpg'">
                        </div>

                        <div class="detail-right">
                            <h2>${card.name}</h2>
                            <p><strong>Tipo:</strong> ${card.types?.join(", ") || "Desconocido"}</p>
                            <p><strong>Rareza:</strong> ${card.rarity || "Desconocida"}</p>
                            <p><strong>Set:</strong> ${card.set.name}</p>
                            <p><strong>HP:</strong> ${card.hp || "?"}</p>

                            <h3>Vendedores Disponibles</h3>
                            <div class="seller-list">
                                ${
                                    listings.length
                                    ? listings.map(listing => {
                                        const available = listing.status === 'aprobada' && listing.isActive !== false;
                                        const availabilityLabel = available ? 'Disponible' : 'No disponible';
                                        return `
                                        <div class="seller-card">
                                            <div class="seller-avatar">${(listing.seller?.name || 'Vendedor')[0]}</div>
                                            <div>
                                                <p class="seller-name">${listing.seller?.name || 'Vendedor sin nombre'}</p>
                                                <p class="seller-rating">${listing.seller?.email || 'Correo no disponible'}</p>
                                                <p class="seller-rating">Rol: ${listing.seller?.role || 'vendedor'}</p>
                                            </div>

                                            ${listing.imageData ? `<div class="seller-thumb"><img src="${listing.imageData}" alt="Foto de la publicación" onerror="this.src='black.jpg'"></div>` : ''}

                                            <div class="seller-price">
                                                $${listing.price}
                                                <span class="seller-condition">(${listing.condition})</span>
                                                <span class="availability-pill ${available ? 'available' : 'unavailable'}">${availabilityLabel}</span>
                                            </div>
                                            ${available
                                                ? `<div class="seller-actions">
                                                    <button class="btn-primary" onclick="createOrder('${listing.id}','compra')">Comprar</button>
                                                    <button class="btn-secondary" onclick="createOrder('${listing.id}','reserva')">Reservar</button>
                                                    <a class="btn-primary" href="mailto:${listing.seller?.email || ''}?subject=Interés%20en%20${encodeURIComponent(card.name)}" target="_blank" rel="noopener noreferrer">Contactar</a>
                                                </div>`
                                                : `<div class="seller-actions disabled">
                                                    <span class="availability-note">No disponible para compra, reserva ni contacto.</span>
                                                </div>`
                                            }
                                        </div>
                                      `; }).join("")
                                    : "<p>No hay vendedores aún.</p>"
                                }
                            </div>
                        </div>

                    </div>
                `;
            } catch (error) {
                console.error(error);
                container.innerHTML = "<p>Error cargando la carta.</p>";
            }
        }

        async function createOrder(listingId, type = 'compra') {
            if (!authToken) return alert('Debes iniciar sesión para continuar.');

            try {
                const res = await apiFetch('/api/orders', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ listingId, type })
                });

                const data = await res.json();
                if (res.ok) {
                    alert(`Orden creada con estado ${data.order.status}. Revisa tu historial.`);
                } else {
                    alert('❌ Error: ' + (data.message || 'No se pudo crear la orden'));
                }
            } catch (error) {
                console.error(error);
                alert('Error de conexión con el servidor.');
            }
        }

        function goBackToCatalog() {
            showSection('view-catalog');
        }

    </script>
</body>
</html>
